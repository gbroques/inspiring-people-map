<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inspiring People Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<style>
    body { margin: 0 }
    html, body, #map { height: 100%; }
</style>
<body>
    <div id="map"></div>
</body>
<script>
    fetch('Inspiring People.csv')
        .then(r => r.text())
        .then(csvToArray)
        .then(rows => rows.filter(row => row.latitude && row.longitude))
        .then(rows => {
            const home = {
                name: 'Home',
                address: 'St. Louis, Missouri',
                latitude: 38.63,
                longitude: -90.20
            };
            const map = initializeMap('map', {
                center: [home.latitude, home.longitude],
                zoom: 3
            });
            [home, ...rows].forEach(row => addRowToMap(map, row));
        });
    function initializeMap(id, options) {
        const map = L.map(id, options);
        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        return map;
    }
    function addRowToMap(map, row) {
        const {latitude, longitude, name, address, url} = row;
        const options = {title: name};
        const popup = [
            `<strong>${name}</strong>`,
            address,
            url && `<a href="${url}" target="_blank">${url}</a>`
        ].filter(Boolean).join('<br />');
        L.marker([latitude, longitude], options)
            .addTo(map)
            .bindPopup(popup);
    }
    function csvToArray(csv) {
        const [headerLine, ...lines] = csv.split(/\r?\n/);
        const headers = headerLine.split(",");

        return lines.map((line, index) =>
            line
            /*
                ,          Split on comma
                (?=        Followed by
                (?:        Start a non-capture group
                    [^"]*  0 or more non-quote characters
                    "      1 quote
                    [^"]*  0 or more non-quote characters
                    "      1 quote
                )*         0 or more repetition of non-capture group (multiple of 2 quotes will be even)
                [^"]*      Finally 0 or more non-quotes
                $          Till the end  (This is necessary, else every comma will satisfy the condition)
                )
            */
            // https://stackoverflow.com/questions/18893390/splitting-on-comma-outside-quotes/18893443#18893443
            .split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/)
            .reduce((object, value, index) => ({
                ...object,
                [headers[index]]: removeSurroundingDoubleQuotesIfPresent(value),
                }),
                {}
            )
        );
        function removeSurroundingDoubleQuotesIfPresent(string) {
            return string.replace(/"(.*)"/, '$1');
        }
    }
</script>
</html>
